<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>libqb: Logging</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="index.html">index</a>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="qb_log_overview">Logging </a></h1><p>The logging API provides four main parts (basics, filtering, threading &amp; blackbox). The idea behind this logging system is not to be prescriptive but to provide a set of tools to help the developer achieve what they want quickly and easily.<dl class="user"><dt><b>Basic logging API.</b></dt><dd>Call <a class="el" href="qblog_8h.html#ac1dcd0ac044680eead32eae864928d71" title="This is the main function to generate a log message.">qb_log()</a> to generate a log message. Then to write the message somewhere meaningful call <a class="el" href="qblog_8h.html#ab19da4babdb23834a25e5865016fb02d" title="Main logging control function.">qb_log_ctl()</a> to configure the targets.</dd></dl>
<p>Simplest possible use: </p>
<div class="fragment"><pre class="fragment"> main() {
        <a class="code" href="qblog_8h.html#a4261a1e62a9195139290b15793b8c4bc" title="Init the logging system.">qb_log_init</a>(<span class="stringliteral">&quot;simple-log&quot;</span>, LOG_DAEMON, LOG_INFO);
        <span class="comment">// ...</span>
        <a class="code" href="qblog_8h.html#ac1dcd0ac044680eead32eae864928d71" title="This is the main function to generate a log message.">qb_log</a>(LOG_WARNING, <span class="stringliteral">&quot;watch out&quot;</span>);
        <span class="comment">// ...</span>
        <a class="code" href="qblog_8h.html#ad6b19c2d1c4de938418820a81d5d622c" title="Logging system finalization function.">qb_log_fini</a>();
 }
</pre></div><dl class="user"><dt><b>Configuring log targets.</b></dt><dd>A log target can be syslog, stderr, the blackbox, stdout, or a text file. By default only syslog is enabled.</dd></dl>
<p>To enable a target do the following: </p>
<div class="fragment"><pre class="fragment">        <a class="code" href="qblog_8h.html#ab19da4babdb23834a25e5865016fb02d" title="Main logging control function.">qb_log_ctl</a>(<a class="code" href="qblog_8h.html#a461cac884ce0c9a80f069af15c6c046aa178ee41f37914617d5d86caf651dab5e">QB_LOG_BLACKBOX</a>, <a class="code" href="qblog_8h.html#aaa6a5dea031c8dc88fbd6d38fd72dee5a05b84aca7698c88c32fed66d60821771">QB_LOG_CONF_ENABLED</a>, <a class="code" href="qbdefs_8h.html#aa53d378f26033634af24bd526090073e">QB_TRUE</a>);
</pre></div>syslog, stderr, the blackbox, and stdout are static (they don't need to be created, just enabled or disabled). However you can open multiple logfiles (QB_LOG_TARGET_MAX - QB_LOG_TARGET_STATIC_MAX). To do this, use the following code: </p>
<div class="fragment"><pre class="fragment">        mytarget = <a class="code" href="qblog_8h.html#a46abb926947f450d5d66255ffd13ef4f" title="Open a log file.">qb_log_file_open</a>(<span class="stringliteral">&quot;/var/log/mylogfile&quot;</span>);
        <a class="code" href="qblog_8h.html#ab19da4babdb23834a25e5865016fb02d" title="Main logging control function.">qb_log_ctl</a>(mytarget, <a class="code" href="qblog_8h.html#aaa6a5dea031c8dc88fbd6d38fd72dee5a05b84aca7698c88c32fed66d60821771">QB_LOG_CONF_ENABLED</a>, <a class="code" href="qbdefs_8h.html#aa53d378f26033634af24bd526090073e">QB_TRUE</a>);
</pre></div>Once your targets are enabled/opened you can configure them as follows: Configure the size of blackbox </p>
<div class="fragment"><pre class="fragment">        <a class="code" href="qblog_8h.html#ab19da4babdb23834a25e5865016fb02d" title="Main logging control function.">qb_log_ctl</a>(<a class="code" href="qblog_8h.html#a461cac884ce0c9a80f069af15c6c046aa178ee41f37914617d5d86caf651dab5e">QB_LOG_BLACKBOX</a>, <a class="code" href="qblog_8h.html#aaa6a5dea031c8dc88fbd6d38fd72dee5a89f358b4a83f94b1efd0e6942506f24d">QB_LOG_CONF_SIZE</a>, 1024*10);
</pre></div>Make logging to file threaded: </p>
<div class="fragment"><pre class="fragment">        <a class="code" href="qblog_8h.html#ab19da4babdb23834a25e5865016fb02d" title="Main logging control function.">qb_log_ctl</a>(mytarget, <a class="code" href="qblog_8h.html#aaa6a5dea031c8dc88fbd6d38fd72dee5a190db017221bea9bc7c3683ca0dcd023">QB_LOG_CONF_THREADED</a>, <a class="code" href="qbdefs_8h.html#aa53d378f26033634af24bd526090073e">QB_TRUE</a>);
</pre></div>To workaround your syslog daemon filtering all messages &gt; LOG_INFO </p>
<div class="fragment"><pre class="fragment">        <a class="code" href="qblog_8h.html#ab19da4babdb23834a25e5865016fb02d" title="Main logging control function.">qb_log_ctl</a>(<a class="code" href="qblog_8h.html#a461cac884ce0c9a80f069af15c6c046aa3811428d4ed722d87211411146622ad4">QB_LOG_SYSLOG</a>, <a class="code" href="qblog_8h.html#aaa6a5dea031c8dc88fbd6d38fd72dee5a9b7cdd1040ac89368d7d10c3caa65c2d">QB_LOG_CONF_PRIORITY_BUMP</a>,
                   LOG_INFO - LOG_DEBUG);
</pre></div>To ensure all logs to file targets are fsync'ed (default QB_FALSE) </p>
<div class="fragment"><pre class="fragment">        <a class="code" href="qblog_8h.html#ab19da4babdb23834a25e5865016fb02d" title="Main logging control function.">qb_log_ctl</a>(mytarget, <a class="code" href="qblog_8h.html#aaa6a5dea031c8dc88fbd6d38fd72dee5abdebc9d9e19cfa3fa4afd5f744260301">QB_LOG_CONF_FILE_SYNC</a>, <a class="code" href="qbdefs_8h.html#aa53d378f26033634af24bd526090073e">QB_TRUE</a>);
</pre></div><dl class="user"><dt><b>Filtering messages.</b></dt><dd>To have more power over what log messages go to which target you can apply filters to the targets. What happens is the desired callsites have the correct bit set. Then when the log message is generated it gets sent to the targets based on which bit is set in the callsite's "target" bitmap. Messages can be filtered based on the:<ol type="1">
<li>filename + priority</li>
<li>function name + priority</li>
<li>format string + priority</li>
</ol>
</dd></dl>
<p>So to make all logs from evil_function() go to stderr, do the following: </p>
<div class="fragment"><pre class="fragment">        <a class="code" href="qblog_8h.html#a687531ff2f457ea5fe63dc91f74be783" title="This allows you modify the &amp;#39;tags&amp;#39; and &amp;#39;targets&amp;#39; callsite fields at...">qb_log_filter_ctl</a>(<a class="code" href="qblog_8h.html#a461cac884ce0c9a80f069af15c6c046aa7667606d44f7b11302762237dff2b8ad">QB_LOG_STDERR</a>, <a class="code" href="qblog_8h.html#a0bcfbbefc6d73b62e72b135ff29fe03faaae48ba27a8dafc2163aaf9637d5ce2f">QB_LOG_FILTER_ADD</a>,
                          <a class="code" href="qblog_8h.html#aa23b899fd898c0c999357532f187fc0fa8991c590b0aa0c3179a8512fbdae9509">QB_LOG_FILTER_FUNCTION</a>, <span class="stringliteral">&quot;evil_function&quot;</span>, <a class="code" href="qblog_8h.html#af7abc145380f1916838e42f9272aa0f6">LOG_TRACE</a>);
</pre></div>So to make all logs from totem* (with a priority &lt;= LOG_INFO) go to stderr, do the following: </p>
<div class="fragment"><pre class="fragment">        <a class="code" href="qblog_8h.html#a687531ff2f457ea5fe63dc91f74be783" title="This allows you modify the &amp;#39;tags&amp;#39; and &amp;#39;targets&amp;#39; callsite fields at...">qb_log_filter_ctl</a>(<a class="code" href="qblog_8h.html#a461cac884ce0c9a80f069af15c6c046aa7667606d44f7b11302762237dff2b8ad">QB_LOG_STDERR</a>, <a class="code" href="qblog_8h.html#a0bcfbbefc6d73b62e72b135ff29fe03faaae48ba27a8dafc2163aaf9637d5ce2f">QB_LOG_FILTER_ADD</a>,
                          <a class="code" href="qblog_8h.html#aa23b899fd898c0c999357532f187fc0fa868c37c795816ee3d64143c4090afbb6">QB_LOG_FILTER_FILE</a>, <span class="stringliteral">&quot;totem&quot;</span>, LOG_INFO);
</pre></div>So to make all logs with the substring "ringbuffer" go to stderr, do the following: </p>
<div class="fragment"><pre class="fragment">        <a class="code" href="qblog_8h.html#a687531ff2f457ea5fe63dc91f74be783" title="This allows you modify the &amp;#39;tags&amp;#39; and &amp;#39;targets&amp;#39; callsite fields at...">qb_log_filter_ctl</a>(<a class="code" href="qblog_8h.html#a461cac884ce0c9a80f069af15c6c046aa7667606d44f7b11302762237dff2b8ad">QB_LOG_STDERR</a>, <a class="code" href="qblog_8h.html#a0bcfbbefc6d73b62e72b135ff29fe03faaae48ba27a8dafc2163aaf9637d5ce2f">QB_LOG_FILTER_ADD</a>,
                          <a class="code" href="qblog_8h.html#aa23b899fd898c0c999357532f187fc0faa12df6f8f73d22379661a8f94d69850f">QB_LOG_FILTER_FORMAT</a>, <span class="stringliteral">&quot;ringbuffer&quot;</span>, <a class="code" href="qblog_8h.html#af7abc145380f1916838e42f9272aa0f6">LOG_TRACE</a>);
</pre></div><dl class="user"><dt><b>Thread safe non-blocking logging.</b></dt><dd>Logging is only thread safe when threaded logging is in use. If you plan on logging from multiple threads, you must initialize libqb's logger thread and use qg_log_filter_ctl to set the QB_LOG_CONF_THREADED flag on all the logging targets in use.</dd></dl>
<p>To achieve non-blocking logging, so that any calls to write() or syslog() will not hold up your program, you can use threaded logging as well.Threaded logging use: </p>
<div class="fragment"><pre class="fragment"> main() {
        <a class="code" href="qblog_8h.html#a4261a1e62a9195139290b15793b8c4bc" title="Init the logging system.">qb_log_init</a>(<span class="stringliteral">&quot;simple-log&quot;</span>, LOG_DAEMON, LOG_INFO);
        <a class="code" href="qblog_8h.html#ab19da4babdb23834a25e5865016fb02d" title="Main logging control function.">qb_log_ctl</a>(<a class="code" href="qblog_8h.html#a461cac884ce0c9a80f069af15c6c046aa3811428d4ed722d87211411146622ad4">QB_LOG_SYSLOG</a>, <a class="code" href="qblog_8h.html#aaa6a5dea031c8dc88fbd6d38fd72dee5a190db017221bea9bc7c3683ca0dcd023">QB_LOG_CONF_THREADED</a>, <a class="code" href="qbdefs_8h.html#aa53d378f26033634af24bd526090073e">QB_TRUE</a>);
        <span class="comment">// ...</span>
        daemonize();
        <span class="comment">// call this after you fork()</span>
        <a class="code" href="qblog_8h.html#aa93049df374b16e48e352327d02be156" title="Start the logging pthread.">qb_log_thread_start</a>();
        <span class="comment">// ...</span>
        <a class="code" href="qblog_8h.html#ac1dcd0ac044680eead32eae864928d71" title="This is the main function to generate a log message.">qb_log</a>(LOG_WARNING, <span class="stringliteral">&quot;watch out&quot;</span>);
        <span class="comment">// ...</span>
        <a class="code" href="qblog_8h.html#ad6b19c2d1c4de938418820a81d5d622c" title="Logging system finalization function.">qb_log_fini</a>();
 }
</pre></div><dl class="user"><dt><b>A blackbox for in-field diagnosis.</b></dt><dd>This stores log messages in a ringbuffer so they can be written to file if the program crashes (you will need to catch SIGSEGV). These can then be easily printed out later.</dd></dl>
<dl class="note"><dt><b>Note:</b></dt><dd>the blackbox is not enabled by default.</dd></dl>
<p>Blackbox usage: </p>
<div class="fragment"><pre class="fragment"> <span class="keyword">static</span> <span class="keywordtype">void</span> sigsegv_handler(<span class="keywordtype">int</span> sig)
 {
        (void)signal (SIGSEGV, SIG_DFL);
        <a class="code" href="qblog_8h.html#aeb2f3aaaa5c32b994e0dc9069bb50ce6" title="Write the blackbox to file.">qb_log_blackbox_write_to_file</a>(<span class="stringliteral">&quot;simple-log.fdata&quot;</span>);
        <a class="code" href="qblog_8h.html#ad6b19c2d1c4de938418820a81d5d622c" title="Logging system finalization function.">qb_log_fini</a>();
        <span class="keyword">raise</span>(SIGSEGV);
 }

 main() {

        signal(SIGSEGV, sigsegv_handler);

        <a class="code" href="qblog_8h.html#a4261a1e62a9195139290b15793b8c4bc" title="Init the logging system.">qb_log_init</a>(<span class="stringliteral">&quot;simple-log&quot;</span>, LOG_DAEMON, LOG_INFO);
        <a class="code" href="qblog_8h.html#a687531ff2f457ea5fe63dc91f74be783" title="This allows you modify the &amp;#39;tags&amp;#39; and &amp;#39;targets&amp;#39; callsite fields at...">qb_log_filter_ctl</a>(<a class="code" href="qblog_8h.html#a461cac884ce0c9a80f069af15c6c046aa178ee41f37914617d5d86caf651dab5e">QB_LOG_BLACKBOX</a>, <a class="code" href="qblog_8h.html#a0bcfbbefc6d73b62e72b135ff29fe03faaae48ba27a8dafc2163aaf9637d5ce2f">QB_LOG_FILTER_ADD</a>,
                          <a class="code" href="qblog_8h.html#aa23b899fd898c0c999357532f187fc0fa868c37c795816ee3d64143c4090afbb6">QB_LOG_FILTER_FILE</a>, <span class="stringliteral">&quot;*&quot;</span>, LOG_DEBUG);
        <a class="code" href="qblog_8h.html#ab19da4babdb23834a25e5865016fb02d" title="Main logging control function.">qb_log_ctl</a>(<a class="code" href="qblog_8h.html#a461cac884ce0c9a80f069af15c6c046aa178ee41f37914617d5d86caf651dab5e">QB_LOG_BLACKBOX</a>, <a class="code" href="qblog_8h.html#aaa6a5dea031c8dc88fbd6d38fd72dee5a89f358b4a83f94b1efd0e6942506f24d">QB_LOG_CONF_SIZE</a>, 1024*10);
        <a class="code" href="qblog_8h.html#ab19da4babdb23834a25e5865016fb02d" title="Main logging control function.">qb_log_ctl</a>(<a class="code" href="qblog_8h.html#a461cac884ce0c9a80f069af15c6c046aa178ee41f37914617d5d86caf651dab5e">QB_LOG_BLACKBOX</a>, <a class="code" href="qblog_8h.html#aaa6a5dea031c8dc88fbd6d38fd72dee5a05b84aca7698c88c32fed66d60821771">QB_LOG_CONF_ENABLED</a>, <a class="code" href="qbdefs_8h.html#aa53d378f26033634af24bd526090073e">QB_TRUE</a>);
        <span class="comment">// ...</span>
        <a class="code" href="qblog_8h.html#ac1dcd0ac044680eead32eae864928d71" title="This is the main function to generate a log message.">qb_log</a>(LOG_WARNING, <span class="stringliteral">&quot;watch out&quot;</span>);
        <span class="comment">// ...</span>
        <a class="code" href="qblog_8h.html#ad6b19c2d1c4de938418820a81d5d622c" title="Logging system finalization function.">qb_log_fini</a>();
 }
</pre></div><dl class="user"><dt><b>Tagging messages.</b></dt><dd>You can tag messages using the second argument to <a class="el" href="qblog_8h.html#a4d29d79cd6bd07e06da9fb56251922f9" title="This is the function to generate a log message if you want to manually add tags.">qb_logt()</a> or by using <a class="el" href="qblog_8h.html#a687531ff2f457ea5fe63dc91f74be783" title="This allows you modify the &#39;tags&#39; and &#39;targets&#39; callsite fields at...">qb_log_filter_ctl()</a>. This can be used to add feature or sub-system information to the logs.</dd></dl>
<div class="fragment"><pre class="fragment"> <span class="keyword">const</span> <span class="keywordtype">char</span>* my_tags_stringify(uint32_t <a class="code" href="structqb__log__callsite.html#a8561f30b7fd7730cb3d39da1cdd963e5">tags</a>) {
        <span class="keywordflow">if</span> (<a class="code" href="qbdefs_8h.html#a429078697a3e130797201e1377bd3fdf">qb_bit_is_set</a>(tags, <a class="code" href="qblog_8h.html#ac357216b86a3fb153c6422c2a44eb0ee">QB_LOG_TAG_LIBQB_MSG_BIT</a>) {
                <span class="keywordflow">return</span> <span class="stringliteral">&quot;libqb&quot;</span>;
        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tags == 3) {
                <span class="keywordflow">return</span> <span class="stringliteral">&quot;three&quot;</span>;
        } <span class="keywordflow">else</span> {
                <span class="keywordflow">return</span> <span class="stringliteral">&quot;MAIN&quot;</span>;
        }
 }
 main() {
        <span class="comment">// ...</span>
        <a class="code" href="qblog_8h.html#a84d94e1a167006c7f69407a56db18291" title="Set the callback to map the &amp;#39;tags&amp;#39; bit map to a string.">qb_log_tags_stringify_fn_set</a>(my_tags_stringify);
        <a class="code" href="qblog_8h.html#a0e8cf298ff5fd224a16537b30a899df9" title="Set the format specifiers.">qb_log_format_set</a>(<a class="code" href="qblog_8h.html#a461cac884ce0c9a80f069af15c6c046aa7667606d44f7b11302762237dff2b8ad">QB_LOG_STDERR</a>, <span class="stringliteral">&quot;[%5g] %p %b&quot;</span>);
        <span class="comment">// ...</span>
        <a class="code" href="qblog_8h.html#a4d29d79cd6bd07e06da9fb56251922f9" title="This is the function to generate a log message if you want to manually add tags.">qb_logt</a>(LOG_INFO, 3, <span class="stringliteral">&quot;hello&quot;</span>);
        <a class="code" href="qblog_8h.html#a4d29d79cd6bd07e06da9fb56251922f9" title="This is the function to generate a log message if you want to manually add tags.">qb_logt</a>(LOG_INFO, 0, <span class="stringliteral">&quot;hello&quot;</span>);
 }
</pre></div><p> The code above will produce: </p>
<div class="fragment"><pre class="fragment"> [libqb] some message
 [three] info hello
 [MAIN ] info hello
</pre></div>  </p>
<dl class="see"><dt><b>See also:</b></dt><dd><a class="el" href="qblog_8h.html" title="The logging API provides four main parts (basics, filtering, threading &amp; blackbox)...">qblog.h</a> </dd></dl>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on 18 Mar 2016 for libqb by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
